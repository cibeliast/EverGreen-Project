<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T-Students</title>

    <!-- Tailwind CSS-->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- BS + BS Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-[#F9FAFB] min-h-screen p-4">
    <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row gap-10">
      <!-- KOTAKAN UTAMA SMUA -->
      <!-- Sidebar Start -->
      <nav
        class="bg-[#1F2A44] rounded-xl w-full md:w-60 flex flex-col justify-between p-6 text-[#a3c0d9] h-[calc(100vh-3rem)]"
      >
        <!-- Nav Atas Start-->
        <!-- LOGO -->
        <div>
          <a
            id="brandTitle"
            class="text-white d-block font-extrabold text-lg mb-4 mt-2 text-center"
            href=""
          >
            <span>EverGreen</span>
          </a>

          <hr class="border-[#ffffff] mb-5" />

          <nav class="flex flex-col gap-5 text-sm">
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#"
            >
              <i class="bi bi-grid-1x2"></i>
              <span class="title">Dashboard</span>
            </a>

            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/all_schedule"
            >
              <i class="bi bi-calendar3"></i>
              <span class="title">Schedules</span>
            </a>

            <a class="flex items-center gap-3 text-[#9FD3C7]" href="">
              <i class="bi bi-people-fill"></i>
              <span class="title">Students</span>
            </a>

            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#"
            >
              <i class="bi bi-question-circle"></i>
              <span class="title">Quizzes</span>
            </a>

            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#"
            >
              <i class="bi bi-credit-card-2-back"></i>
              <span class="title">Payment History</span>
            </a>
          </nav>
        </div>
        <!-- Nav Atas End-->

        <div>
          <!-- Nav Bawah Start-->
          <hr class="border-[#ffffff] mb-6" />
          <nav class="flex flex-col gap-5 text-sm font-semibold text-[#a3c0d9]">
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#"
            >
              <i class="bi bi-person-circle"></i>
              <span class="title">Profile</span>
            </a>

            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#"
            >
              <i class="bi bi-box-arrow-right"></i>
              <span class="title">Log out</span>
            </a>
          </nav>
        </div>
        <!-- Nav bawah End-->
      </nav>
      <!-- Sidebar End -->

      <!-- Main Content Start -->
      <main class="flex-1 flex flex-col gap-6 pt-8 pr-7">
        <!-- Main Judul -->
        <section>
          <h2 class="text-3xl font-extrabold text-[#111827] mb-1">Students</h2>
          <p class="text-sm text-[#6b7280]">
            Get to know your students better! Browse student profiles, see their
            schedules, and stay connected in one click.
          </p>
        </section>

        <hr />
        <!-- Garis -->

        <!-- Searching -->
        <form class="d-flex" role="search" id="searchForm">
          <input
            class="form-control me-2 text-base"
            type="search"
            placeholder="Search student by name"
            aria-label="Search"
            id="searchInput"
          />
        </form>

        <!-- Card Dynamic -->
        <!-- Card Container -->
        <div
          id="cardContainer"
          class="max-h-[526px] overflow-y-auto rounded-lg scroll-container p-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          Loading data...
        </div>

        <!-- Pop Up Delete -->
        <div
          id="confirmModal"
          class="fixed inset-0 hidden bg-[#000000] bg-opacity-50 flex items-center justify-center z-50"
        >
          <div
            class="bg-white p-6 rounded-lg shadow-md text-center max-w-sm w-full"
          >
            <h2 class="mb-4 text-xl font-semibold">Delete Student</h2>
            <p class="mb-3">Are you sure you want to delete this student?</p>
            <div class="flex justify-center gap-4">
              <button
                id="confirmNo"
                class="w-[140px] bg-[#FFFFFF] border-2 border-[#9FD3C7] px-4 py-2 rounded hover:bg-[#9FD3C7] transition"
              >
                No
              </button>

              <button
                id="confirmYes"
                class="w-[140px] bg-[#9FD3C7] text-[#000000] px-4 py-2 rounded hover:bg-[#57998A] hover:text-white"
              >
                Yes
              </button>
            </div>
          </div>
        </div>

        <!-- Script -->
        <script>
          document.addEventListener("DOMContentLoaded", async () => {
            const cardContainer = document.getElementById("cardContainer");
            const searchInput = document.getElementById("searchInput");
            let allStudents = [];

            try {
              const response = await fetch("/teacher/api/students");
              if (!response.ok) {
                throw new Error("Failed to fetch students");
              }
              allStudents = await response.json();

              renderStudents(allStudents);

              // Search listener
              searchInput.addEventListener("input", () => {
                const keyword = searchInput.value.trim().toLowerCase();
                const filteredStudents = allStudents.filter((student) =>
                  (student.name || "").toLowerCase().includes(keyword)
                );
                renderStudents(filteredStudents);
              });
            } catch (error) {
              console.error("Error fetching students:", error);
              cardContainer.innerHTML = "<p>Error loading students data.</p>";
            }
          });

          let selectedStudentId = null;

          // Fungsi ambil inisial (2 huruf depan dari 2 kata pertama)
          function getInitials(name) {
            if (!name) return "?";
            const words = name.trim().split(" ");
            if (words.length === 1) return words[0][0].toUpperCase();
            return (words[0][0] + words[1][0]).toUpperCase();
          }

          function renderStudents(data) {
            const cardContainer = document.getElementById("cardContainer");
            cardContainer.innerHTML = "";

            if (data.length === 0) {
              cardContainer.innerHTML = "<p>No students found.</p>";
              return;
            }

            data.forEach((student) => {
              const studentCard = document.createElement("div");
              studentCard.className =
                "bg-white rounded-lg shadow-md p-3 relative";

              // Tentukan elemen foto: jika ada foto_url pakai <img>, kalau tidak pakai lingkaran huruf
              const photoElement = student.photo_url
                ? `<img
            alt="Profile picture of ${student.name}"
            class="w-20 h-20 mb-2 rounded-full object-cover mx-auto"
            src="${student.photo_url}"
          />`
                : `<div class="w-20 h-20 mb-2 rounded-full bg-[#93B9D6] text-white flex items-center justify-center text-2xl font-bold mx-auto">
            ${getInitials(student.name)}
          </div>`;

              studentCard.innerHTML = `
        <!-- Overlay Action Delete -->
        <div id="popupOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

        <!-- Titik 3 ... -->
        <div class="absolute top-2 right-2 z-50">
          <button onclick="toggleMenu(this)">
            <i class="bi bi-three-dots mr-3 text-gray-600 hover:text-black text-lg"></i>
          </button>

          <!-- Pop-up Action-->
          <div class="action-menu hidden absolute right-0 mt-2 rounded-xl shadow-md p-2 w-[140px] bg-white z-50 flex flex-col items-center">
            <h2 class="text-lg font-semibold mb-2 text-[#000000]">Action</h2>

            <!-- Button Delete -->
            <div class="right-0 mt-2 w-32 bg-[#FFE4E6] rounded">
              <button onclick="showConfirmModal('${student.student_id}')" 
                class="text-[#000000] px-4 py-2 w-full text-left hover:bg-[#E2B0B5] rounded">
                <i class="bi bi-trash3-fill mr-2"></i>Delete
              </button>
            </div>
          </div>
        </div>

        <!-- Info Data Student -->
        <div class="text-center pb-2 pt-2">
          <!-- Photo Profile -->
          ${photoElement}

          <!-- Student Name & ID Number-->
          <h2 class="text-lg font-semibold mx-auto">${student.name}</h2>
          <p class="text-sm text-[#6b7280]">ID Student: ${
            student.student_id
          }</p>
        </div>

        <!-- Info Schedule -->
        <div class="bg-[#E0EBF5] rounded pl-5 pr-3 pt-3 pb-3">
          <p class="text-sm">
            <i class="bi bi-pin-fill mr-2"></i>Schedule
          </p>
          <div class="pl-6 text-sm mb-1">
            ${
              student.schedule
                ?.split(",")
                .map((item, i) => `<p>${i + 1}. ${item.trim()}</p>`)
                .join("") || "<p>No schedule</p>"
            }
          </div>

          <!-- Total Meetings -->
          <div class="text-sm mb-2">
            <p><i class="bi bi-stack mr-2"></i>${
              student.total_meetings || 0
            }x Meetings</p>
          </div>

          <!-- Address & Phone Number -->
          <div class="flex flex-col text-sm gap-2">
            <div class="flex items-start">
              <i class="bi bi-house-fill mr-2 mt-1"></i>
              <p class="break-words">${student.address || "No address"}</p>
            </div>
            
            <div class="flex items-center">
              <i class="bi bi-telephone-fill mr-2"></i>
              <p>${student.phone_number || "-"}</p>
            </div>
          </div>
        </div>
      `;

              cardContainer.appendChild(studentCard);
            });
          }

          // Pop Up Action Delete
          function toggleMenu(button) {
            // Tutup semua menu
            document
              .querySelectorAll(".action-menu")
              .forEach((menu) => menu.classList.add("hidden"));

            // Sembunyikan overlay dulu
            document.getElementById("popupOverlay").classList.add("hidden");

            const menu = button.nextElementSibling;
            const isAlreadyOpen = !menu.classList.contains("hidden");

            // Jika belum terbuka, tampilkan menu dan overlay
            if (!isAlreadyOpen) {
              menu.classList.remove("hidden");
              document
                .getElementById("popupOverlay")
                .classList.remove("hidden");
            }
          }

          // Untuk ilangin pop up ketika klik di halaman luar pop up
          document.addEventListener("click", function (e) {
            if (
              !e.target.closest(".action-menu") &&
              !e.target.closest("button")
            ) {
              document
                .querySelectorAll(".action-menu")
                .forEach((menu) => menu.classList.add("hidden"));
              document.getElementById("popupOverlay").classList.add("hidden");
            }
          });

          // Untuk Pop Up Delete - Yes or No
          function showConfirmModal(studentId) {
            selectedStudentId = studentId;
            const confirmModal = document.getElementById("confirmModal");
            confirmModal.classList.remove("hidden");
            document.body.classList.add("modal-open");
          }

          document
            .getElementById("confirmYes")
            .addEventListener("click", async () => {
              if (selectedStudentId) {
                try {
                  const response = await fetch(
                    `/teacher/api/students/${selectedStudentId}`,
                    {
                      method: "DELETE",
                    }
                  );
                  if (!response.ok) {
                    throw new Error("Failed to delete student");
                  }
                  alert("Data siswa berhasil dihapus.");
                  location.reload();
                } catch (error) {
                  console.error("Error deleting student:", error);
                  alert("Gagal menghapus data siswa.");
                } finally {
                  document
                    .getElementById("confirmModal")
                    .classList.add("hidden");
                  document.body.classList.remove("modal-open");
                  selectedStudentId = null;
                }
              }
            });

          document.getElementById("confirmNo").addEventListener("click", () => {
            document.getElementById("confirmModal").classList.add("hidden");
            document.body.classList.remove("modal-open");
            selectedStudentId = null;
          });
        </script>
      </main>
      <!-- Main Content End -->
    </div>
    <!-- KOTAKAN UTAMA SMUA end -->

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

<!-- CSS -->
<style>
  body {
    font-family: "Poppins", sans-serif;
  }

  #brandTitle {
    font-size: 30px;
  }

  .title {
    font-size: 18px;
    font-weight: 600;
    text-decoration: none; /* ini penting kalau pakai <a> */
  }

  .navbar-custom {
    background-color: #1f2a44;
    margin: 15px;
    border-radius: 15px;
    font-weight: bolder;
    letter-spacing: 0.5px;
  }

  .search {
    font-size: 16px;
  }

  .student-card {
    border: 1px solid #333;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 5px;
  }

  .scroll-container {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scroll-container::-webkit-scrollbar {
    display: none;
  }
</style>
