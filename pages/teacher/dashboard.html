<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Dashboard</title>

    <!-- Tailwind CSS-->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Calendar -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- BS + BS Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-[#F9FAFB] min-h-screen p-4">
    <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row gap-10">
      <!-- Sidebar Start -->
      <nav
        class="bg-[#1F2A44] rounded-xl w-full md:w-60 flex flex-col justify-between p-6 text-[#a3c0d9] h-[calc(100vh-3rem)]"
      >
        <div>
          <a
            id="brandTitle"
            class="text-white d-block font-extrabold text-lg mb-4 mt-2 text-center"
            href=""
          >
            <span>EverGreen</span>
          </a>
          <hr class="border-[#ffffff] mb-5" />
          <nav class="flex flex-col gap-5 text-sm">
            <a class="flex items-center gap-3 text-[#9FD3C7]" href="">
              <i class="bi bi-grid-1x2-fill"></i>
              <span class="title">Dashboard</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/all_schedule"
            >
              <i class="bi bi-calendar3"></i>
              <span class="title">Schedules</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#FFFFFF]"
              href="/teacher/students"
            >
              <i class="bi bi-people"></i>
              <span class="title">Students</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#FFFFFF] hover:text-[#9FD3C7] transition-colors"
              href="/topicTeacher"
            >
              <i class="bi bi-question-circle"></i>
              <span class="title">Quizzes</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/payment"
            >
              <i class="bi bi-credit-card-2-back"></i>
              <span class="title">Payment History</span>
            </a>
          </nav>
        </div>
        <div>
          <hr class="border-[#ffffff] mb-6" />
          <nav class="flex flex-col gap-5 text-sm font-semibold text-[#a3c0d9]">
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/profile"
            >
              <i class="bi bi-person-circle"></i>
              <span class="title">Profile</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#" id="logoutTrigger"
            >
              <i class="bi bi-box-arrow-right"></i>
              <span class="title">Log out</span>
            </a>
          </nav>
        </div>
      </nav>
      <!-- Sidebar End -->

      <!-- Main Content Start -->
      <main class="flex-1 flex flex-col gap-6 pt-3 pr-7">
        <section>
          <h2 class="text-3xl font-extrabold text-[#111827] mb-1">
            Teacher Dashboard
          </h2>
          <p class="text-sm text-[#6b7280]">
            Manage Your Day, Teach with Ease.
          </p>
        </section>

        <hr />

        <!-- Card Container -->
        <div class="w-full">
          <div id="cardContainer">

            <!-- Bungkus Horizontal: Kiri & Kanan -->
            <div class="flex flex-col lg:flex-row gap-4 w-full">

              <!-- Bagian Kiri: Upcoming Class + My Schedule -->
              <div class="flex flex-col flex-1 gap-4">

                <!-- Upcoming Class (Ijo) -->
              <div class="h-[180px] bg-[#d0e0e5] rounded-xl pt-3 px-8 flex flex-col gap-2">
                <!-- Judul -->
                <h2 class="font-semibold text-lg text-[#111827]">Upcoming Class</h2>

                <!-- Kotak putih dengan scroll horizontal -->
                <div id="upcoming-schedule" class="bg-white rounded-lg p-3 overflow-x-auto overflow-y-hidden w-full justify-center">

                    <!-- CARD 1 -->
                    <div class="flex flex-col items-center gap-2 min-w-[80px]">
                      <div class="font-lg text-xs w-5 h-5 rounded-full bg-[#93B9D6] text-white flex items-center justify-center mx-auto">1</div>
                      <div>
                        <p class="font-bold text-xs text-[#111827] text-center">English</p>
                        <p class="text-xs text-[#6b7280] text-center">10:00 - 11:00</p>
                      </div>
                    </div>

                    <!-- CARD 2 -->
                    <div class="flex flex-col items-center gap-2 min-w-[80px]">
                      <div class="font-lg text-xs w-5 h-5 rounded-full bg-[#93B9D6] text-white flex items-center justify-center mx-auto">2</div>
                      <div>
                        <p class="font-bold text-xs text-[#111827] text-center">Math</p>
                        <p class="text-xs text-[#6b7280] text-center">11:00 - 12:00</p>
                      </div>
                    </div>

                    <!-- Tambah lebih banyak item sesuka kamu -->
                </div>
              </div>


                <!-- My Schedule -->
                <div class="h-[370px] bg-[#FFFFFF] rounded-xl shadow-2xl pb-2 px-8 flex flex-col gap-2">
                  <h3 class="font-semibold text-lg text-[#111827] pt-3">My schedule</h3>
                  <div class="overflow-y-auto scroll-container bg-white rounded-xl overflow-hidden">
                    <table class="min-w-full text-xs text-left">
                      <thead class="bg-[#1F2A44] text-white">
                        <tr>
                          <th class="py-3 px-4 font-semibold sticky top-0 bg-[#1F2A44] z-10">No</th>
                          <th class="py-3 px-4 font-semibold sticky top-0 bg-[#1F2A44] z-10">Day</th>
                          <th class="py-3 px-4 font-semibold sticky top-0 bg-[#1F2A44] z-10">Time</th>
                          <th class="py-3 px-4 font-semibold sticky top-0 bg-[#1F2A44] z-10">Student</th>
                        </tr>
                      </thead>
                      <tbody id="schedule-body" class="text-gray-700">
                        <!-- JS akan inject jadwal di sini -->
                      </tbody>
                    </table>
                  </div>
                </div>

              </div>

              <!-- Bagian Kanan: Calendar + Online Students -->
              <div class="flex flex-col flex-1 gap-4 max-w-[300px]">

                <!-- Calendar -->
                <section >
                  <div class="right-top">
                    <div id="myCalendar"></div>
                  </div>
                </section>

                <!-- Online Students -->
                <div class="h-[242px] bg-[#d0e0e5] rounded-xl pb-6 px-4 flex flex-col gap-2">
                  <h3 class="font-semibold text-lg text-[#111827] pt-3 mb-2">Online Students</h3>
                  <div class="max-h-[220px] overflow-y-auto scroll-container rounded-md overflow-hidden">
                    <div class="student-list flex flex-col gap-2 mb-3" id="student-list">
                      <!-- JS akan inject student cards di sini -->
                    </div>
                  </div>
                </div>

              </div>

            </div>
            <!-- End Horizontal Wrapper -->
          </div>
        </div>

        <!-- Modal logout -->
         <div
          id="confirmModal"
          class="fixed inset-0 hidden bg-[#000000] bg-opacity-50 flex items-center justify-center z-50"
        >
          <div
            class="bg-white p-6 rounded-lg shadow-md text-center max-w-sm w-full"
          >
            <h2 class="mb-4 text-xl font-semibold">Logout</h2>
            <p class="mb-3">Are you sure you want to log out?</p>
            <div class="flex justify-center gap-4">
              <button
                id="confirmNo"
                class="w-[140px] bg-[#FFFFFF] border-2 border-[#9FD3C7] px-4 py-2 rounded hover:bg-[#9FD3C7] transition"
              >
                No
              </button>
              <button
                id="confirmYes"
                class="w-[140px] bg-[#9FD3C7] text-[#000000] px-4 py-2 rounded hover:bg-[#57998A] hover:text-white"
              >
                Yes
              </button>
            </div>
          </div>
        </div>
      </main><!-- Main Content End -->

      <!-- CDN Flatpickr -->
      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

      <style>
        .flatpickr-calendar {
          background: #ffffff;
          font-size: 12px;
          /* border: 1px solid #A69ACA; */
          font-family: "Poppins", sans-serif;
          border-radius: 8px;
          box-shadow: 0 1px 10px rgba(0, 0, 0, 0.15);
        }

        .flatpickr-month {
          height: 45px !important;
        }
        .flatpickr-current-month {
          background-color: #e3f5f5;
          margin-top: 10px;
          border-radius: 30px;
          padding: 5px;
          font-size: 12.6px;
          height: 30px;
        }

        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange {
          color: black;
          border: 3px solid #e3f5f5;
          background-color: white;
        }

        .flatpickr-day.today {
          background: #e3f5f5;
          border: none;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
          appearance: none;
          -webkit-appearance: none;
          -moz-appearance: none;
          background-image: none !important;
        }
      </style>

      <script>
        flatpickr("#myCalendar", {
          inline: true,
          defaultDate: "today",
        });
      </script>

      <script>
        function formatTimeRange(startTime, durationMinutes = 60) {
          const [hour, minute] = startTime.split(':').map(Number);
          const start = new Date(0, 0, 0, hour, minute);
          const end = new Date(start.getTime() + durationMinutes * 60000);
        
          const format = (d) => d.toTimeString().slice(0, 5); // hasil: "08:00"
          return `${format(start)} - ${format(end)}`;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
          fetch('/api/scheduleTeacherDashboard') // ganti jika route kamu beda
            .then(res => {
              if (!res.ok) throw new Error("Unauthorized or error");
              return res.json();
            })
            .then(data => {
              const tbody = document.getElementById('schedule-body');
              tbody.innerHTML = ''; // Clear if needed

              if (data.length === 0) {
                tbody.innerHTML = `
                  <tr>
                    <td colspan="4" class="text-center py-3">No schedule available</td>
                  </tr>
                `;
                return;
              }

              // Nentuin urutan hari
              const dayOrder = {
                "Monday": 1,
                "Tuesday": 2,
                "Wednesday": 3,
                "Thursday": 4,
                "Friday": 5,
                "Saturday": 6,
                "Sunday": 7
              };

              // Fungsi bantu untuk parsing jam ke angka menit
              const parseTimeToMinutes = (timeStr) => {
                const [hour, minute] = timeStr.split(':').map(Number);
                return hour * 60 + minute;
              };

              // Sort data berdasarkan hari dan jam
              data.sort((a, b) => {
                const dayA = dayOrder[a.day] || 999;
                const dayB = dayOrder[b.day] || 999;
                if (dayA !== dayB) return dayA - dayB;

                return parseTimeToMinutes(a.time) - parseTimeToMinutes(b.time);
              });

              // Data tabel jadwal
              data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'border';
                row.innerHTML = `
                  <td class="py-2 px-3">${index + 1}</td>
                  <td class="py-2 px-3">${item.day}</td>
                  <td class="py-3 px-4">${formatTimeRange(item.time, item.duration || 60)}</td>

                  <td class="py-2 px-3">
                    <div class="flex items-center space-x-2">
                      <span class="w-8 h-8 rounded-full bg-[#AB91CD] text-white text-xs font-semibold flex items-center justify-center select-none">
                        ${item.student_name.charAt(0).toUpperCase()}
                      </span>
                      <span class="font-semibold text-gray-900">
                        ${item.student_name}
                      </span>
                    </div>
                  </td>
                `;
                tbody.appendChild(row);
              });
            })
            .catch(error => {
              console.error("Error fetching schedule:", error);
              const tbody = document.getElementById('schedule-body');
              tbody.innerHTML = `
                <tr>
                  <td colspan="4" class="text-center py-3 text-red-500">Failed to load schedule</td>
                </tr>
              `;
            });
        });

        // Ambil dan filter jadwal untuk hari ini → Upcoming Class
        fetch('/api/scheduleTeacherDashboard')
        .then(res => {
          if (!res.ok) throw new Error("Unauthorized or error");
          return res.json();
        })
        .then(data => {
          const today = new Date().toLocaleString('en-US', { weekday: 'long' });
          const upcomingData = data.filter(item => item.day === today);
      
          const container = document.getElementById('upcoming-schedule');
          container.innerHTML = '';
      
          if (upcomingData.length === 0) {
            container.innerHTML = `<p class="text-sm text-gray-500 text-center">No class today.</p>`;
            return;
          }
      
          // 🔽 Bikin WRAPPER fleksibel di dalam kotak putih
          const scrollWrapper = document.createElement('div');
          scrollWrapper.className = 'flex gap-6 w-max'; // ⬅️ HANYA wrapper yang melebar
      
          upcomingData.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'flex flex-col items-center gap-2 min-w-[100px] ';
            div.innerHTML = `
              <div class="font-lg text-xs w-5 h-5 rounded-full bg-[#93B9D6] text-white flex items-center justify-center mx-auto">${index + 1}</div>
              <div>
                <p class="font-bold text-xs text-[#111827] text-center">${item.student_name}</p>
                <p class="text-xs text-[#6b7280] text-center">${formatTimeRange(item.time, item.duration || 60)}</p>

              </div>
            `;
            scrollWrapper.appendChild(div);
          });
      
          container.appendChild(scrollWrapper); // masukkan ke dalam kotak putih
        })
        .catch(error => {
          console.error('Failed to load upcoming schedule:', error);
          const container = document.getElementById('upcoming-schedule');
          container.innerHTML = `<p class="text-sm text-red-500 text-center">Failed to load upcoming schedule</p>`;
        });
      
        // Online student
       fetch('/teacher/api/students')
          .then(res => res.json())
          .then(students => {
            const container = document.getElementById('student-list');
            container.innerHTML = ''; // Kosongkan dulu

            // Filter latest online
            students.sort((a, b) => {
              const getMinutes = (label) => {
                if (label === 'Online now') return 0;
                if (label.includes('minute')) return parseInt(label);
                if (label.includes('hour')) return parseInt(label) * 60;
                if (label.includes('day')) return parseInt(label) * 1440;
                return Infinity; // untuk "Never online"
              };

              return getMinutes(a.last_seen) - getMinutes(b.last_seen);
            });

            students.forEach(student => {
              const initials = student.name.trim().charAt(0).toUpperCase();

              const studentDiv = document.createElement('div');
              studentDiv.className = 'student bg-white rounded-md p-2 flex items-center gap-2';
              studentDiv.innerHTML = `
                <div class="w-6 h-6 rounded-full bg-[#305DC5] text-white text-[10px] font-semibold flex items-center justify-center select-none">
                  ${initials}
                </div>
                <div class="text-xs font-semibold text-[#111827]">
                  ${student.name}
                  <p class="text-[8px] font-normal text-[#6b7280]">${student.last_seen}</p>
                </div>
              `;
              container.appendChild(studentDiv);
            });
          });

          const logoutTrigger = document.getElementById('logoutTrigger');
          const confirmModal = document.getElementById('confirmModal');
          const confirmYes = document.getElementById('confirmYes');
          const confirmNo = document.getElementById('confirmNo');

          // Tampilkan modal saat klik "Log out"
          logoutTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            confirmModal.classList.remove('hidden');
          });

          // Klik "No" → sembunyikan modal
          confirmNo.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
          });

          // Klik "Yes" → redirect ke logout
          confirmYes.addEventListener('click', () => {
            window.location.href = "/logout"; // atau fetch POST kalau pakai method post
          });
      </script>
    </div>
    <!-- KOTAKAN UTAMA SMUA end -->

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

<!-- CSS -->
<style>
  body {
    font-family: "Poppins", sans-serif;
  }

  #brandTitle {
    font-size: 30px;
  }

  .title {
    font-size: 18px;
    font-weight: 600;
    text-decoration: none; /* ini penting kalau pakai <a> */
  }

  .navbar-custom {
    background-color: #1f2a44;
    margin: 15px;
    border-radius: 15px;
    font-weight: bolder;
    letter-spacing: 0.5px;
  }

  .search {
    font-size: 16px;
  }

  .student-card {
    border: 1px solid #333;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 5px;
  }

  .scroll-container {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scroll-container::-webkit-scrollbar {
    display: none;
  }
</style>
