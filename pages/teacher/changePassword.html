<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Change Password</title>

    <!-- Tailwind CSS-->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Calendar -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- BS + BS Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-[#F9FAFB] min-h-screen p-4">
    <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row">
      <!-- Sidebar Start -->
      <nav
        class="bg-[#1F2A44] rounded-xl w-full md:w-80 flex flex-col justify-between p-6 text-[#a3c0d9] h-[calc(100vh-3rem)]"
        
      >
        <div>
          <a
            id="brandTitle"
            class="text-white d-block font-extrabold text-lg mb-4 mt-2 text-center"
            href=""
          >
            <span>EverGreen</span>
          </a>
          <hr class="border-[#ffffff] mb-5" />
          <nav class="flex flex-col gap-5 text-sm">
            <a class="flex items-center gap-3 text-[#FFFFFF] hover:text-[#9FD3C7] " href="/dashboard/teacher">
              <i class="bi bi-grid-1x2"></i>
              <span class="title">Dashboard</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/all_schedule"
            >
              <i class="bi bi-calendar3"></i>
              <span class="title">Schedules</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#FFFFFF] hover:text-[#9FD3C7] "
              href="/teacher/students"
            >
              <i class="bi bi-people"></i>
              <span class="title">Students</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#FFFFFF] hover:text-[#9FD3C7] transition-colors"
              href="/topicTeacher"
            >
              <i class="bi bi-question-circle"></i>
              <span class="title">Quizzes</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="/payment"
            >
              <i class="bi bi-credit-card-2-back"></i>
              <span class="title">Payment History</span>
            </a>
          </nav>
        </div>
        <div>
          <hr class="border-[#ffffff] mb-6" />
          <nav class="flex flex-col gap-5 text-sm font-semibold text-[#a3c0d9]">
            <a
              class="flex items-center gap-3 text-[#9FD3C7] transition-colors"
              href="/profile"
            >
              <i class="bi bi-person-circle"></i>
              <span class="title">Profile</span>
            </a>
            <a
              class="flex items-center gap-3 text-[#ffffff] hover:text-[#9FD3C7] transition-colors"
              href="#" id="logoutTrigger"
            >
              <i class="bi bi-box-arrow-right"></i>
              <span class="title">Log out</span>
            </a>
          </nav>
        </div>
      </nav>
      <!-- Sidebar End -->

      <!-- Main Content Start -->
        <div class="dashboard-container h-[calc(100vh-3rem)]">
            <div class="left-profile">
            <div id="profile-initial" class="w-20 h-20 rounded-full bg-[#67998D] text-white text-2xl font-bold flex items-center justify-center mx-auto mb-2 uppercase">?</div>
            <h5 id="profile-username">Loading...</h5>
            <p id="profile-id"class="display_id"></p>
            
            <ul>
                <li><a href="/profile"><i class="bi bi-person-circle"></i> Account details</a></li>
                <li><a href="#"><i class="bi bi-key"></i> Change password</a></li>
            </ul>
            </div>

            <div class="right-profile">
            <h3>Change Password</h3>
            <p>Your password must be at least 6 characters and should include a combination of numbers an letters.</p>
            <form action="/routes/changePassword.js" id="change-password-form" method="POST">

                <label for="exampleFormControlInput1" class="form-label">Previous password</label>
                <input type="password" class="form-control" id="prevPassword" name="prevPassword">

                <label for="exampleFormControlInput1" class="form-label">New password</label>
                <input type="password" class="form-control" id="newPassword" name="newPassword">

                <label for="exampleFormControlInput1" class="form-label">Confirm new password</label>
                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">

                <a href="/forgot-password">Forgot your password?</a>

                <div class="row">
                <div class="col d-grid">
                <button class="btn" type="button" id="btn-discard"> Discard Changes</button>
                </div>

                <div class="col d-grid">
                <button class="btn" type="submit" id="btn-save"> Save Changes</button>
                </div>

                </div>
                </form>
            </div>
        </div>
      <!-- Main Content End -->

      <!-- Modal logout -->
       <div
        id="confirmModal"
        class="fixed inset-0 hidden bg-[#000000] bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white p-6 rounded-lg shadow-md text-center max-w-sm w-full"
        >
          <h2 class="mb-4 text-xl font-semibold">Logout</h2>
          <p class="mb-3">Are you sure you want to log out?</p>
          <div class="flex justify-center gap-4">
            <button
              id="confirmNo"
              class="w-[140px] bg-[#FFFFFF] border-2 border-[#9FD3C7] px-4 py-2 rounded hover:bg-[#9FD3C7] transition"
            >
              No
            </button>
            <button
              id="confirmYes"
              class="w-[140px] bg-[#9FD3C7] text-[#000000] px-4 py-2 rounded hover:bg-[#57998A] hover:text-white"
            >
              Yes
            </button>
          </div>
        </div>
      </div>

      <script>
      document.addEventListener('DOMContentLoaded', () => {
          fetch('/api/profile')
            .then(response => response.json())
            .then(data => {
              if (!data.error) {
                document.getElementById('profile-username').innerHTML = `${data.username}`;
                document.getElementById('profile-id').innerHTML = `ID - ${data.teacher_id}`; 

                const initials = getInitials(data.name || data.username || '');
            document.getElementById('profile-initial').textContent = initials;
              } 
            })
            .catch(err => {
              console.error('Fetch error: ', err);
            });
        });
        // HANDLER SAVE CHANGES
       document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const prevPassword = document.getElementById('prevPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if(newPassword !== confirmPassword) {
                showStatus("New password don't match", "/assets/error.png");
                return;
            }

            try {
                const res = await fetch('/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({prevPassword, newPassword})
                });

                const result = await res.text();
                if (res.ok) {
                sessionStorage.setItem("statusMessage", "Password updated successfully!");
                sessionStorage.setItem("statusImage", "/assets/success.png");
                location.reload();
                } else {
                alert(result);
                }
            } catch (error) {
                console.error(error);
                showStatus("Something went wrong!", "/assets/error.png");
            }
            });

        // HANDLER DISCARD
            document.getElementById('btn-discard').addEventListener('click', (e) => {
            e.preventDefault();
            // Lakukan fetch ulang atau reload halaman
            location.reload();
        });

        function getInitials(name) {
      const names = name.trim().split(" ");
      if (names.length === 1) return names[0].charAt(0).toUpperCase();
      return (names[0].charAt(0) + names[names.length - 1].charAt(0)).toUpperCase();
    }

        window.addEventListener("DOMContentLoaded", () => {
              const message = sessionStorage.getItem("statusMessage");
              const image = sessionStorage.getItem("statusImage");

              if (message && image) {
                showStatus(message, image);
                // Hapus setelah ditampilkan agar tidak muncul terus
                sessionStorage.removeItem("statusMessage");
                sessionStorage.removeItem("statusImage");
              }
            });

            const logoutTrigger = document.getElementById('logoutTrigger');
            const confirmModal = document.getElementById('confirmModal');
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');

            // Tampilkan modal saat klik "Log out"
            logoutTrigger.addEventListener('click', (e) => {
              e.preventDefault();
              confirmModal.classList.remove('hidden');
            });

            // Klik "No" → sembunyikan modal
            confirmNo.addEventListener('click', () => {
              confirmModal.classList.add('hidden');
            });

            // Klik "Yes" → redirect ke logout
            confirmYes.addEventListener('click', () => {
              window.location.href = "/logout"; // atau fetch POST kalau pakai method post
            });
      </script>
    </div>
    <!-- KOTAKAN UTAMA SMUA end -->

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { setupStatusModal, showStatus } from '/js/statusModal.js';
      setupStatusModal();
      window.showStatus = showStatus;
    </script>
  </body>
</html>

<!-- CSS -->
<style>
  body {
    font-family: "Poppins", sans-serif;
    overflow: hidden;
  }

  #brandTitle {
    font-size: 30px;
  }

  .title {
    font-size: 18px;
    font-weight: 600;
    text-decoration: none; /* ini penting kalau pakai <a> */
  }

  .navbar-custom {
    background-color: #1f2a44;
    margin: 15px;
    border-radius: 15px;
    font-weight: bolder;
    letter-spacing: 0.5px;
  }

  .search {
    font-size: 16px;
  }

  .student-card {
    border: 1px solid #333;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 5px;
  }

  .scroll-container {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scroll-container::-webkit-scrollbar {
    display: none;
  }

  h3 {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
    }

    h5 {
      font-size: 20px;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 0;
      color: #67998D;
    }

    .dashboard-container {
      display: grid;
      grid-template-columns: minmax(250px, 300px) 1fr;
      gap: 20px;
      margin: 20px;
      margin-top: 0;
      height: calc(100vh-3rem);
      font-size: 13px;
    }

    .left-profile {
      background-color: #ffffff;
      padding: 30px;
      padding-top: 60px;
      border-radius: 20px;
      box-shadow: 0 1px 10px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: center;
      gap: 6px;
    }

    img {
      border-radius: 100px;
      width: 60%;
    }

    h3 {
      font-weight: 600;
      margin: 0;
    }

    h5 {
      color: #67998D;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 0;
    }

    .display_id {
      margin: 0;
      color: #67998D;
      background-color: #F0FFF8;
      border-radius: 50px;
      padding: 4px 8px;
    }

    p {
      color: #7D7B7B;
      margin: 0;
    }

    
    .left-profile ul {
      width: 100%;
      padding: 0;
      /* margin-top: 20px; */
    }

    .left-profile li {
      list-style-type: none;
      margin-top: 5px;
      letter-spacing: 0.1px;
      font-weight: 600;
    }
    
    .left-profile li:nth-child(2) a {
      background-color: #1F2A44;
      color: #ffffff;
      border-radius: 8px;
    }
    
    .left-profile a {
      padding: 10px;
      color: #1F2A44;
      text-decoration: none;
      
      display: block;
    }
    
    .left-profile i {
     margin-right: 10px;
    }

    .right-profile {
      background-color: #ffffff;
      border-radius: 20px;
      box-shadow: 0 1px 10px rgba(0, 0, 0, 0.25);
      padding: 45px 50px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .right-profile .row {
      margin-top: 77.5px;
    }

    .right-profile .btn {
      background-color: #1F2A44;
      color: white;
    }

    .right-profile p {
        margin-bottom: 20px;
    }

    .right-profile a {
      
      text-decoration: none;
      color: #67998D;
      font-weight: 600;
    }

    .right-profile label {
      margin-bottom: 5px;
    }

    .right-profile input {
      margin-bottom: 15px;
    }
</style>
